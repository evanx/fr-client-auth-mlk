# lula-auth

Microservice providing /register and /login endpoints for pre-authorized client auth.

## Usage

See https://github.com/evanx/lula-auth/blob/master/bin/test.sh

The Administrator will generate a registration token and deadline for the client.

```shell
regToken=`node bin/bcrypt.js hash test-regToken`
```

```shell
regDeadline=`node -e 'console.log(Date.now()+3600*1000)'`
```

The registration details, namely `regToken` and `regDeadline,` are stored in Redis for the client e.g. `test-client.`

```shell
redis-cli hset lula:client:test-client:h regToken "${regToken}"
redis-cli hset lula:client:test-client:h regDeadline "${regDeadline}"
```

The client generates their `secret.`

```
openssl rand 24 -base64
```

The client registers their `secret` using the `regToken` provided by the Administrator.

```shell
curl -s -X 'POST' \
  -d 'client=test-client&secret=my-secret&regToken=test-regToken' \
  -H 'Content-Type: application/x-www-form-urlencoded' \
  -H 'Accept: application/json' \
  http://127.0.0.1:3000/register
```

The client logs in using their `secret,` and receives a session token.

```shell
token=`curl -s -X 'POST' -d 'client=test-client&secret=my-secret' \
  -H 'Content-Type: application/x-www-form-urlencoded' \
  -H 'Accept: application/json' \
  http://127.0.0.1:3000/login | jq -r '.token'`
```

The client accesses a related API using the session token as a `Bearer` token in the `Authorization` header.

```
Authorization: Bearer {token}
```

<hr>

![test.sh](/docs/test.jpg?raw=true 'test.sh')

## Endpoints

### /register

https://github.com/evanx/lula-auth/tree/master/lib/register

- `client` - the ID of the client
- `secret` - the secret chosen by the client
- `regToken` - the token provided for registration

#### Requires

Pre-authorisation of the registration via hashes key `client:${client}:h` with fields:

- `regToken` - the bcrypted hash of the token issued to the client for registration
- `regDeadline` - the epoch deadline for the registration by the client

#### Result

The secret is hashed using Bcrypt and stored in Redis.

See https://github.com/kelektiv/node.bcrypt.js

#### Usage

The client might generate its secret as follows:

```shell
$ openssl rand 24 -base64
TTDJ2uqo6VxIvaqiX52xEn8b2daxEhFV
```

The `regToken` might be similarly generated by the Administrator and provisioned to the client.

### /login

https://github.com/evanx/lula-auth/tree/master/lib/login

- `client` - the ID of the client
- `secret` - the secret chosen by the client

#### Requires

Hashes key `client:${client}:h` with field:

- `secret` - the `/register` secret, salted and hashed using Bcrypt

#### Returns

- `token` - a session token
- `ttlSeconds` - the TTL of the token

This session token is intended to be used as an HTTP auth "Bearer" token.

Note that once the token expires, the client should login again e.g. in the event of a 401 error.

## Example usage

### lula-hub

See https://github.com/evanx/lula-hub

This project enables Redis stream ingress from authenticated clients via "Bearer" token.

```javascript
fastify.register(require('fastify-bearer-auth'), {
  auth: async (token, request) => {
    const client = await fastify.redis.hget(`session:${token}:h`, 'client')
    if (client) {
      request.client = client
      return true
    }
    return false
  },
  errorResponse: err => {
    return { code: 401, message: err.message }
  },
})
```

where the client includes the `token` from `/login` in the HTTP `Authorization` header:

```
Authorization: Bearer {token}
```

## Related

- https://github.com/evanx/lula-hub
